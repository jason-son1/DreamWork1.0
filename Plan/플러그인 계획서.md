# Project DreamWork: 자체 플러그인(DreamCore) 상세 설계 및 분석

## 1. 개요 (Overview)

본 플러그인(`DreamCore`)은 [야생 + 타운 + RPG] 서버의 핵심 로직을 담당합니다. 기존 플러그인(Towny, Essentials, MythicMobs)이 인프라를 담당한다면, DreamCore는 유저의 **성장(직업/스탯)** 과 **동기 부여(퀘스트)** 시스템을 연결하는 미들웨어 역할을 수행합니다.

## 2. 시스템 아키텍처 (System Architecture)

플러그인은 **Manager Pattern**을 사용하여 각 기능을 모듈화하고, 메인 클래스에서 이를 제어합니다.

### 2.1 패키지 구조 제안

```
kr.dreamwork.core
├── DreamCore.java (Main Class)
├── api (외부 플러그인 연동용 API)
├── config (YAML 설정 파일 관리)
├── database (HikariCP, DAO, DTO)
│   ├── DatabaseManager.java
│   └── SQLite/MySQL 구현체
├── manager
│   ├── JobManager.java (직업 로직)
│   ├── StatManager.java (스탯 계산 및 적용)
│   ├── QuestManager.java (퀘스트 생성 및 추적)
│   └── GuiManager.java (인벤토리 UI 처리)
├── module
│   ├── jobs (JobProvider 구현체들: Miner, Fisher...)
│   └── stats (StatCalculator 구현체)
└── listeners (이벤트 리스너)
    ├── PlayerJoinQuitListener.java
    ├── JobActivityListener.java (채광, 낚시 등 감지)
    └── CombatListener.java (스탯 기반 데미지 연산)
```

## 3. 데이터베이스 설계 (Database Schema)

**요구사항:** 소규모(SQLite) / 대규모(MySQL/MariaDB) 호환. 비동기 I/O 필수.

### 3.1 테이블 구조 (Schema)

모든 데이터는 `uuid`를 Foreign Key로 사용하여 정규화합니다.

**1. `dw_users` (유저 기본 정보)** | Field | Type | Description | | :--- | :--- | :--- | | `uuid` | VARCHAR(36) | Primary Key | | `name` | VARCHAR(16) | 유저 닉네임 (동기화용) | | `job_main` | VARCHAR(32) | 현재 선택한 직업 | | `last_login` | TIMESTAMP | 마지막 접속 시간 |

**2. `dw_user_jobs` (직업 레벨 및 경험치)** | Field | Type | Description | | :--- | :--- | :--- | | `uuid` | VARCHAR(36) | Foreign Key | | `job_id` | VARCHAR(32) | 직업 식별자 (miner, fisher 등) | | `level` | INT | 현재 레벨 | | `exp` | DOUBLE | 현재 경험치 | | `total_exp` | DOUBLE | 누적 경험치 (랭킹용) |

**3. `dw_user_stats` (스탯 포인트)** | Field | Type | Description | | :--- | :--- | :--- | | `uuid` | VARCHAR(36) | Foreign Key | | `stat_str` | INT | 힘 (근접 공격력) | | `stat_dex` | INT | 민첩 (치명타/이속) | | `stat_int` | INT | 지능 (스킬 쿨타임/마나) | | `stat_luk` | INT | 행운 (드롭률) | | `points_left` | INT | 미분배 스탯 포인트 |

**4. `dw_quests` (퀘스트 진행도)** | Field | Type | Description | | :--- | :--- | :--- | | `uuid` | VARCHAR(36) | Foreign Key | | `quest_id` | VARCHAR(64) | 퀘스트 ID | | `status` | VARCHAR(10) | ACTIVE, COMPLETED, REWARDED | | `progress` | INT | 현재 진행도 (목표 갯수 등) | | `started_at` | TIMESTAMP | 시작 시간 (일일 퀘스트 초기화 체크용) |

## 4. 핵심 모듈 상세 설계

### 4.1 직업 시스템 (Job System)

**목표:** 단순 노가다가 아닌 성장 체감 제공. `JobProvider` 인터페이스를 통해 확장성 확보.

- **로직 흐름:**
    
    1. `JobActivityListener`에서 유저 행동 감지 (예: 블럭 파괴).
        
    2. `JobManager`가 해당 행동이 현재 유저 직업의 경험치 획득 조건인지 확인.
        
    3. 조건 충족 시 `addExp(Player, amount)` 호출.
        
    4. 레벨업 발생 시 `UserLevelUpEvent` 호출 (칭호 부여, 스탯 포인트 지급).
        
- **설정 파일 구조 (`jobs.yml` 예시):**
    
    ```
    miner:
      name: "광부"
      max-level: 100
      exp-sources:
        - type: BLOCK_BREAK
          target: DIAMOND_ORE
          amount: 50.0
        - type: BLOCK_BREAK
          target: STONE
          amount: 0.5
      rewards:
        level-10:
          - "give %player% iron_pickaxe 1"
          - "money give %player% 1000"
    ```
    

### 4.2 RPG 스탯 시스템 (Stat System)

**목표:** 전투 및 채집 효율에 직접적인 영향.

- **스탯 공식 (Formula):**
    
    - **공격력(DMG):** $$ Damage = Base + (STR \times 0.5) + (WeaponDamage) $$
        
    - **치명타 확률(Crit):** $$ Chance = \frac{DEX}{DEX + 100} \times 100 (%) $$
        
    - **채집 보너스:** $$ DropMultiplier = 1 + (LUK \times 0.01) $$
        
- **구현 방식:**
    
    - `StatManager`는 접속 시 유저 데이터를 로드하여 메모리에 `HashMap<UUID, PlayerStat>` 형태로 캐싱합니다(DB 부하 최소화).
        
    - `EntityDamageByEntityEvent` 등에서 `StatManager.get(player)`를 통해 계산된 데미지를 적용합니다.
        

### 4.3 퀘스트 시스템 (Quest System)

**목표:** 일일 접속 유도 및 경제 순환.

- **구조:**
    
    - **Daily Quest:** 매일 자정(00:00) 서버 시간 기준 초기화.
        
    - **Pool System:** `quest_pool.yml`에 50개 정도의 퀘스트를 정의해두고, 유저마다 랜덤 3개를 할당.
        
- **UI (GUI):**
    
    - `InventoryClickEvent`를 가로채서 퀘스트 수락/완료/보상 수령 처리.
        

## 5. 외부 플러그인 후킹 (Hooking)

### 5.1 Vault API (경제)

- **용도:** 퀘스트 보상으로 돈 지급, 전직 비용 차감.
    
- **구현:** `RegisteredServiceProvider<Economy>`를 통해 `Economy` 객체를 확보해야 함.
    

### 5.2 PlaceholderAPI (PAPI)

- **용도:** 채팅창, 탭 리스트, 스코어보드에 내 정보 표시.
    
- **Placeholders:**
    
    - `%dreamcore_job%`: 현재 직업
        
    - `%dreamcore_level%`: 직업 레벨
        
    - `%dreamcore_str%`: 힘 스탯
        
    - `%dreamcore_exp_percent%`: 경험치 퍼센트
        

### 5.3 MythicMobs (선택 사항)

- **용도:** 특정 보스 몬스터 처치 퀘스트.
    
- **구현:** `MythicMobDeathEvent`를 리스닝하여 퀘스트 타겟인지 확인.
    

## 6. 비동기 처리 및 성능 최적화 (Optimization)

**필수 사항:** 메인 스레드(Main Thread) 멈춤 현상(Lag) 방지.

1. **DB I/O:** `Bukkit.getScheduler().runTaskAsynchronously()` 내부에서만 DB `SELECT/INSERT/UPDATE` 수행.
    
2. **데이터 동기화:**
    
    - **접속 시(Join):** 비동기로 DB 로드 -> 로드 완료 후 메인 스레드에서 메모리 적용.
        
    - **종료 시(Quit):** 메모리 데이터를 비동기로 DB 저장.
        
    - **주기적 저장:** 5~10분마다 `AutoSaveTask` 실행.
        

## 7. 개발 로드맵 제안 (Priority)

1. **1주차:** DB 모듈 작성 및 기본 유저 데이터(직업, 스탯 0) 저장/로드 테스트.
    
2. **2주차:** `JobProvider` 구현 및 광부/농부 직업의 경험치 획득 로직 구현.
    
3. **3주차:** 스탯 GUI 제작 및 스탯 포인트에 따른 데미지 공식 적용.
    
4. **4주차:** 퀘스트 시스템 및 외부 플러그인(PAPI, Vault) 연동.